<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Gaussian-VRM + nanoPAD2 Motion Switch</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #ui {
      position: fixed;
      top: 8px; left: 8px;
      background: rgba(0,0,0,0.6);
      color: #0f0;
      font: 12px monospace;
      padding: 8px 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="ui">
    <div><b>nanoPAD2:</b> ÂêÑ„Éë„ÉÉ„Éâ„Åß„É¢„Éº„Ç∑„Éß„É≥ÂàáÊõø</div>
    <div>Current FBX: <span id="motionName">Idle.fbx</span></div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
      "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.1.0/lib/three-vrm.module.js",
      "gaussian-splats-3d": "https://naruya.github.io/gs-edit/lib/gaussian-splats-3d.module.js",
      "jszip": "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm",
      "gvrm": "https://naruya.github.io/gs-edit/lib/gaussian-vrm.min.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GVRM } from 'gvrm';

    const motionLabel = document.getElementById("motionName");
    const canvas = document.getElementById('canvas');
    const renderer = new THREE.WebGLRenderer({ canvas });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.01, 100);
    camera.position.set(0, 0.4, 1.5);

    // --- „É¢„Éº„Ç∑„Éß„É≥„É™„Çπ„Éà ---
    const motions = [
      "Idle.fbx",
      "Walking.fbx",
      "Breathing.fbx",
      "Gangnam Style.fbx",
      "Warrior.fbx",
      "Listening.fbx",
      "Shrugging.fbx",
      "Chicken Dance.fbx",
      "Pointing.fbx",
      "Around.fbx",
      "Acknowledging.fbx",
      "Dizzy Idle.fbx",
      "Happy Idle.fbx",
      "Jab Cross.fbx"
    ];

    let currentMotion = "Idle.fbx";
    let gvrm;

    // ===== GVRMË™≠„ÅøËæº„Åø =====
    gvrm = await GVRM.load('../assets/sample5.gvrm', scene, camera, renderer);
    await gvrm.changeFBX('../assets/' + currentMotion);
    console.log("‚úÖ Loaded GVRM +", currentMotion);

    // ===== nanoPAD2Êé•Á∂ö =====
    if ("requestMIDIAccess" in navigator) {
      const midi = await navigator.requestMIDIAccess();
      for (const input of midi.inputs.values()) {
        if (input.name && input.name.toLowerCase().includes("nanopad")) {
          console.log("üéõ Connected to", input.name);
          input.onmidimessage = async (e) => {
            const [status, note, velocity] = e.data;
            const type = status & 0xF0;

            if (type === 0x90 && velocity > 0) { // NOTE ON
              const padIndex = note - 36; // nanoPAD2 PAD1=36
              if (padIndex >= 0 && padIndex < motions.length) {
                const motion = motions[padIndex];
                currentMotion = motion;
                motionLabel.textContent = motion;
                console.log("üé¨ Changing to:", motion);
                try {
                  await gvrm.changeFBX(`../assets/${motion}`);
                } catch (err) {
                  console.warn("‚ùå FBX load failed:", motion, err);
                }
              }
            }
          };
        }
      }
    } else {
      console.warn("Web MIDI not supported in this browser.");
    }

    // ===== ÊèèÁîª„É´„Éº„Éó =====
    renderer.setAnimationLoop((time) => {
      if (gvrm) {
        gvrm.update();
        renderer.render(scene, camera);
      }
    });
  </script>
</body>
</html>
