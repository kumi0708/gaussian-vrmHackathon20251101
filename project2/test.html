<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Mic RMS (Recorder-compatible)</title>
</head>
<body style="background:black;color:white;font-family:monospace;">
<h3>ğŸ¤ Mic RMS (Recorder-compatible)</h3>
<pre id="log"></pre>

<script>
const log = document.getElementById("log");

async function setupMic() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audioCtx = new AudioContext({ sampleRate: 48000 });
  const src = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  src.connect(analyser);

  const buffer = new Uint8Array(analyser.fftSize);

  console.log("[DEBUG] Mic connected:", stream.getAudioTracks());
  loop();

  function loop() {
    analyser.getByteTimeDomainData(buffer);
    // 0ã€œ255 â†’ -1ã€œ1ã«å¤‰æ›
    let sum = 0;
    for (let i = 0; i < buffer.length; i++) {
      const val = (buffer[i] - 128) / 128;
      sum += val * val;
    }
    const rms = Math.sqrt(sum / buffer.length);
    log.textContent = "rms=" + rms.toFixed(4);
    requestAnimationFrame(loop);
  }
}

setupMic().catch(err => {
  log.textContent = "Error: " + err;
});
</script>
</body>
</html>
